apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    app: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      serviceAccountName: prometheus
      containers:
        - name: prometheus
          image: prom/prometheus:v2.53.0
          args:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=7d"
            - "--web.enable-lifecycle"
          ports:
            - containerPort: 9090
              name: http
          volumeMounts:
            - name: config
              mountPath: /etc/prometheus/prometheus.yml
              subPath: prometheus.yml
            - name: rules
              mountPath: /etc/prometheus/rules
              readOnly: true
            - name: data
              mountPath: /prometheus
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            httpGet:
              path: /-/ready
              port: 9090
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: 9090
            initialDelaySeconds: 15
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: prometheus-config
        # ============================================================
        # Projected Volume: merges independent Rule Pack ConfigMaps
        # into /etc/prometheus/rules/ (matched by rule_files: "*.yml")
        # Each ConfigMap is maintained by its respective team.
        #
        # optional: true — 允許租戶透過 kubectl delete cm 卸載不需要的
        # Rule Pack，Prometheus 不會因缺少 ConfigMap 而 Crash。
        # 大型客戶可關閉黃金標準，改用 migrate_rule.py 轉出的
        # 自訂規則包 (configmap-rules-custom-*.yaml)。
        # ============================================================
        - name: rules
          projected:
            sources:
              - configMap:
                  name: prometheus-rules-mariadb
                  optional: true
                  items:
                    - key: mariadb-recording.yml
                      path: mariadb-recording.yml
                    - key: mariadb-alert.yml
                      path: mariadb-alert.yml
              - configMap:
                  name: prometheus-rules-kubernetes
                  optional: true
                  items:
                    - key: kubernetes-recording.yml
                      path: kubernetes-recording.yml
                    - key: kubernetes-alert.yml
                      path: kubernetes-alert.yml
              - configMap:
                  name: prometheus-rules-redis
                  optional: true
                  items:
                    - key: redis-recording.yml
                      path: redis-recording.yml
                    - key: redis-alert.yml
                      path: redis-alert.yml
              - configMap:
                  name: prometheus-rules-mongodb
                  optional: true
                  items:
                    - key: mongodb-recording.yml
                      path: mongodb-recording.yml
                    - key: mongodb-alert.yml
                      path: mongodb-alert.yml
              - configMap:
                  name: prometheus-rules-elasticsearch
                  optional: true
                  items:
                    - key: elasticsearch-recording.yml
                      path: elasticsearch-recording.yml
                    - key: elasticsearch-alert.yml
                      path: elasticsearch-alert.yml
              - configMap:
                  name: prometheus-rules-oracle
                  optional: true
                  items:
                    - key: oracle-recording.yml
                      path: oracle-recording.yml
                    - key: oracle-alert.yml
                      path: oracle-alert.yml
              - configMap:
                  name: prometheus-rules-db2
                  optional: true
                  items:
                    - key: db2-recording.yml
                      path: db2-recording.yml
                    - key: db2-alert.yml
                      path: db2-alert.yml
              - configMap:
                  name: prometheus-rules-clickhouse
                  optional: true
                  items:
                    - key: clickhouse-recording.yml
                      path: clickhouse-recording.yml
                    - key: clickhouse-alert.yml
                      path: clickhouse-alert.yml
              - configMap:
                  name: prometheus-rules-platform
                  optional: true
                  items:
                    - key: platform-alert.yml
                      path: platform-alert.yml
        - name: data
          emptyDir: {}
