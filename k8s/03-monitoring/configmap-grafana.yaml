apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-provisioning
  namespace: monitoring
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus.monitoring.svc.cluster.local:9090
        isDefault: true
        editable: true

  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: "default"
        orgId: 1
        folder: ""
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /etc/grafana/provisioning/dashboards
          foldersFromFilesStructure: false

  mariadb-overview.json: |
    {
      "annotations": { "list": [] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "title": "MariaDB Up Status",
          "type": "stat",
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
          "targets": [{
            "expr": "mysql_up",
            "legendFormat": "{{ instance }}"
          }],
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "options": { "0": { "text": "DOWN", "color": "red" }, "1": { "text": "UP", "color": "green" } }, "type": "value" }
              ],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "green", "value": 1 }] }
            }
          }
        },
        {
          "title": "Uptime (seconds)",
          "type": "stat",
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
          "targets": [{
            "expr": "mysql_global_status_uptime",
            "legendFormat": "{{ instance }}"
          }],
          "fieldConfig": { "defaults": { "unit": "s" } }
        },
        {
          "title": "Active Connections",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
          "targets": [{
            "expr": "mysql_global_status_threads_connected",
            "legendFormat": "{{ instance }}"
          }]
        },
        {
          "title": "Queries Per Second",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
          "targets": [{
            "expr": "rate(mysql_global_status_queries[5m])",
            "legendFormat": "{{ instance }}"
          }]
        },
        {
          "title": "InnoDB Buffer Pool Usage",
          "type": "gauge",
          "gridPos": { "h": 6, "w": 12, "x": 0, "y": 12 },
          "targets": [{
            "expr": "mysql_global_status_innodb_buffer_pool_pages_data / mysql_global_status_innodb_buffer_pool_pages_total * 100",
            "legendFormat": "{{ instance }}"
          }],
          "fieldConfig": { "defaults": { "unit": "percent", "max": 100 } }
        },
        {
          "title": "Table Rows by Schema",
          "type": "bargauge",
          "gridPos": { "h": 6, "w": 12, "x": 12, "y": 12 },
          "targets": [{
            "expr": "mysql_info_schema_table_rows{schema='vibe_db'}",
            "legendFormat": "{{ instance }} / {{ table }}"
          }]
        }
      ],
      "schemaVersion": 39,
      "tags": ["mariadb", "database"],
      "templating": { "list": [] },
      "time": { "from": "now-30m", "to": "now" },
      "timepicker": {},
      "timezone": "",
      "title": "MariaDB Overview",
      "uid": "mariadb-overview"
    }
