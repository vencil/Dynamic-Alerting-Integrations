apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-init
  namespace: db-a
data:
  01-schema.sql: |
    USE vibe_db;

    CREATE TABLE IF NOT EXISTS users (
        id          BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        username    VARCHAR(50)  NOT NULL UNIQUE,
        email       VARCHAR(255) NOT NULL UNIQUE,
        password    VARCHAR(255) NOT NULL,
        created_at  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        INDEX idx_users_email (email)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    CREATE TABLE IF NOT EXISTS posts (
        id          BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id     BIGINT UNSIGNED NOT NULL,
        title       VARCHAR(255) NOT NULL,
        content     TEXT,
        published   BOOLEAN      NOT NULL DEFAULT FALSE,
        created_at  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        INDEX idx_posts_user (user_id),
        INDEX idx_posts_published (published, created_at),
        CONSTRAINT fk_posts_user FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

  02-seed.sql: |
    USE vibe_db;
    INSERT INTO users (username, email, password) VALUES
        ('alice', 'alice@example.com', 'hashed_pw_placeholder'),
        ('bob',   'bob@example.com',   'hashed_pw_placeholder');
    INSERT INTO posts (user_id, title, content, published) VALUES
        (1, 'Hello World',     'First post from db-a.', TRUE),
        (2, 'Bob on db-a',    'Hi from Bob!',           TRUE);

  03-exporter-user.sql: |
    -- 建立 exporter 專用帳號並授權
    CREATE USER IF NOT EXISTS 'exporter'@'%' IDENTIFIED BY 'changeme_user_pw';
    GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'%';
    FLUSH PRIVILEGES;
