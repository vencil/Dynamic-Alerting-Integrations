# ============================================================
# Rule Pack: ClickHouse (via built-in /metrics or clickhouse_exporter)
# 選配 — 涵蓋 Queries、Connections、Parts、Replication、Memory、MergeRate
#
# 需要的 exporter:
#   - ClickHouse 內建 Prometheus endpoint (/metrics)
#   - 或 clickhouse_exporter (https://github.com/ClickHouse/clickhouse_exporter)
#
# 對應的 threshold-exporter defaults (加入 _defaults.yaml):
#   clickhouse_queries_rate: 500
#   clickhouse_active_connections: 200
#   clickhouse_max_part_count: 300
#   clickhouse_replication_queue: 50
#   clickhouse_memory_tracking_bytes: 8589934592   # 8 GB
#
# Tenant config 範例 (conf.d/clickhouse-prod.yaml):
#   tenants:
#     clickhouse-prod:
#       clickhouse_queries_rate: "300"
#       clickhouse_active_connections: "150"
#       # ── Regex 維度閾值 (v0.12.0 B1 feature) ──
#       # "clickhouse_max_part_count{database=~\"prod_.*\"}": "200"
# ============================================================
groups:
  # ─────────────────────────────────────────────
  # 1. Normalization Recording Rules
  # ─────────────────────────────────────────────
  - name: clickhouse-normalization
    rules:
      # Query rate (5m)
      - record: tenant:clickhouse_queries:rate5m
        expr: |
          sum by(tenant) (
            rate(ClickHouseProfileEvents_Query{tenant!=""}[5m])
          )

      # Active connections (current)
      - record: tenant:clickhouse_active_connections:max
        expr: |
          max by(tenant) (
            ClickHouseMetrics_TCPConnection{tenant!=""}
          )

      # Max part count for partition (hotspot indicator)
      - record: tenant:clickhouse_max_part_count:max
        expr: |
          max by(tenant) (
            ClickHouseAsyncMetrics_MaxPartCountForPartition{tenant!=""}
          )

      # Replication queue size
      - record: tenant:clickhouse_replication_queue:max
        expr: |
          max by(tenant) (
            ClickHouseMetrics_ReplicatedSendQueueSize{tenant!=""}
            + ClickHouseMetrics_ReplicatedFetchQueueSize{tenant!=""}
          )

      # Memory tracking (current resident bytes)
      - record: tenant:clickhouse_memory_tracking:max
        expr: |
          max by(tenant) (
            ClickHouseMetrics_MemoryTracking{tenant!=""}
          )

      # Background merge rate (5m)
      - record: tenant:clickhouse_merges_rate:rate5m
        expr: |
          sum by(tenant) (
            rate(ClickHouseProfileEvents_MergedRows{tenant!=""}[5m])
          )

      # Failed queries rate (5m)
      - record: tenant:clickhouse_failed_queries:rate5m
        expr: |
          sum by(tenant) (
            rate(ClickHouseProfileEvents_FailedQuery{tenant!=""}[5m])
          )

  # ─────────────────────────────────────────────
  # 2. Threshold Normalization (user_threshold → per-tenant ceiling)
  # ─────────────────────────────────────────────
  - name: clickhouse-threshold-normalization
    rules:
      - record: tenant:alert_threshold:clickhouse_queries_rate
        expr: |
          max by(tenant) (
            user_threshold{metric="clickhouse_queries_rate", severity="warning"}
          )

      - record: tenant:alert_threshold:clickhouse_active_connections
        expr: |
          max by(tenant) (
            user_threshold{metric="clickhouse_active_connections", severity="warning"}
          )

      - record: tenant:alert_threshold:clickhouse_max_part_count
        expr: |
          max by(tenant) (
            user_threshold{metric="clickhouse_max_part_count", severity="warning"}
          )

      - record: tenant:alert_threshold:clickhouse_replication_queue
        expr: |
          max by(tenant) (
            user_threshold{metric="clickhouse_replication_queue", severity="warning"}
          )

      - record: tenant:alert_threshold:clickhouse_memory_tracking_bytes
        expr: |
          max by(tenant) (
            user_threshold{metric="clickhouse_memory_tracking_bytes", severity="warning"}
          )

  # ─────────────────────────────────────────────
  # 3. Alert Rules
  # ─────────────────────────────────────────────
  - name: clickhouse-alerts
    rules:
      # --- Availability ---
      - alert: ClickHouseDown
        expr: up{job="clickhouse"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "ClickHouse instance is DOWN"

      # --- Query Rate ---
      - alert: ClickHouseHighQueryRate
        expr: |
          (
            tenant:clickhouse_queries:rate5m
            > on(tenant) group_left
            tenant:alert_threshold:clickhouse_queries_rate
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ClickHouse query rate exceeds threshold"

      # --- Active Connections ---
      - alert: ClickHouseHighConnections
        expr: |
          (
            tenant:clickhouse_active_connections:max
            > on(tenant) group_left
            tenant:alert_threshold:clickhouse_active_connections
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ClickHouse active connections exceed threshold"

      # --- Max Part Count (partition merge pressure) ---
      - alert: ClickHouseHighPartCount
        expr: |
          (
            tenant:clickhouse_max_part_count:max
            > on(tenant) group_left
            tenant:alert_threshold:clickhouse_max_part_count
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ClickHouse max part count per partition exceeds threshold (merge pressure)"

      # --- Replication Queue ---
      - alert: ClickHouseReplicationLag
        expr: |
          (
            tenant:clickhouse_replication_queue:max
            > on(tenant) group_left
            tenant:alert_threshold:clickhouse_replication_queue
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ClickHouse replication queue size exceeds threshold"

      # --- Memory Tracking ---
      - alert: ClickHouseHighMemoryUsage
        expr: |
          (
            tenant:clickhouse_memory_tracking:max
            > on(tenant) group_left
            tenant:alert_threshold:clickhouse_memory_tracking_bytes
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ClickHouse memory tracking exceeds threshold"

      # --- Failed Queries (fixed threshold, no user override) ---
      - alert: ClickHouseHighFailedQueryRate
        expr: |
          tenant:clickhouse_failed_queries:rate5m > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ClickHouse failed query rate > 10/s"
