# Default values for mariadb-instance
# Override via values-db-a.yaml / values-db-b.yaml

instance: db-a

mariadb:
  image: mariadb:11
  rootPassword: changeme_root_pw
  database: vibe_db
  exporterUser: exporter
  exporterPassword: changeme_user_pw

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  config: |
    [mysqld]
    character-set-server = utf8mb4
    collation-server = utf8mb4_unicode_ci
    max_connections = 100
    innodb_buffer_pool_size = 128M
    innodb_log_file_size = 32M
    slow_query_log = 1
    slow_query_log_file = /var/log/mysql/slow.log
    long_query_time = 1

exporter:
  image: prom/mysqld-exporter:v0.15.1
  collectors:
    - global_status
    - global_variables
    - info_schema.tables
    - slave_status
    - auto_increment.columns
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

storage:
  size: 1Gi
  storageClass: standard

# Init SQL â€” schema + seed data + exporter user
initSQL:
  schema: |
    CREATE DATABASE IF NOT EXISTS vibe_db;
    USE vibe_db;

    CREATE TABLE IF NOT EXISTS users (
      id INT AUTO_INCREMENT PRIMARY KEY,
      username VARCHAR(50) NOT NULL UNIQUE,
      email VARCHAR(100) NOT NULL,
      password_hash VARCHAR(255) NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

    CREATE TABLE IF NOT EXISTS posts (
      id INT AUTO_INCREMENT PRIMARY KEY,
      user_id INT NOT NULL,
      title VARCHAR(200) NOT NULL,
      content TEXT,
      published BOOLEAN DEFAULT FALSE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

  seed: |
    USE vibe_db;
    INSERT IGNORE INTO users (username, email, password_hash) VALUES
      ('alice', 'alice@example.com', SHA2('password123', 256)),
      ('bob', 'bob@example.com', SHA2('password456', 256));
    INSERT IGNORE INTO posts (user_id, title, content, published) VALUES
      (1, 'Hello World', 'First post from Alice', TRUE),
      (1, 'Draft Post', 'Work in progress', FALSE),
      (2, 'Bob''s Post', 'Hello from Bob', TRUE),
      (2, 'Another Day', 'Just another post', TRUE);
