# ============================================================
# Platform Dynamic Alert Rules — 可直接合併至 Prometheus ConfigMap
# ============================================================
groups:
  - name: custom_migrated-alert-rules
    rules:
      # --- RedisQueueTooLong ---
      - alert: CustomRedisQueueTooLong
        expr: |
          (
            tenant:custom_redis_queue_length:max
            > on(tenant) group_left
            tenant:alert_threshold:custom_redis_queue_length
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 3m
        labels:
          severity: critical
          source: legacy
          migration_status: shadow
        annotations:
          summary: "Redis queue {{ $labels.queue }} is too long"

      # --- ESIndexTooLarge ---
      - alert: CustomESIndexTooLarge
        expr: |
          (
            tenant:custom_elasticsearch_indices_store_size_bytes_total:sum
            > on(tenant) group_left
            tenant:alert_threshold:custom_elasticsearch_indices_store_size_bytes_total
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 10m
        labels:
          severity: warning
          source: legacy
          migration_status: shadow
        annotations:
          summary: "ES index {{ $labels.index }} exceeds size limit"

      # --- ESIndexDocCountHigh ---
      - alert: CustomESIndexDocCountHigh
        expr: |
          (
            tenant:custom_elasticsearch_indices_docs_total:sum
            > on(tenant) group_left
            tenant:alert_threshold:custom_elasticsearch_indices_docs_total
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 15m
        labels:
          severity: warning
          source: legacy
          migration_status: shadow

      # --- MongoDBStorageTooLarge ---
      - alert: CustomMongoDBStorageTooLarge
        expr: |
          (
            tenant:custom_mongodb_dbstats_storage_size:sum
            > on(tenant) group_left
            tenant:alert_threshold:custom_mongodb_dbstats_storage_size
          )
          unless on(tenant) (user_state_filter{filter="maintenance"} == 1)
        for: 10m
        labels:
          severity: warning
          source: legacy
          migration_status: shadow

